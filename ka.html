<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カー運転ゲーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* ダークな背景色 */
            color: #e2e8f0; /* 明るいテキスト色 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden; /* スクロールバーが出ないように */
        }
        .game-container {
            background-color: #2d3748; /* ダークなコンテナ */
            border-radius: 1.5rem; /* より丸く */
            padding: 2.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            max-width: 600px; /* ゲームエリアの最大幅 */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: center;
        }
        canvas {
            background-color: #38a169; /* 道路の背景色 (緑) */
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: block; /* 余分なスペースを削除 */
            width: 100%; /* 親要素の幅に合わせる */
            max-width: 400px; /* 最大幅を設定 */
            height: 500px; /* 固定の高さ */
        }
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #4299e1; /* ボタンに境界線を追加 */
        }
        .btn-primary {
            background-color: #4299e1; /* 青 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #6b7280; /* 灰色 */
            color: white;
            border-color: #6b7280;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-2px);
        }
        .message-box {
            background-color: #2c5282; /* メッセージ用の濃い青 */
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            font-size: 1.1rem;
            min-height: 3rem; /* メッセージ表示領域の確保 */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .score-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #68d391; /* 緑色でスコア */
            text-align: center;
            width: 100%;
        }
        .instructions {
            font-size: 0.9rem;
            color: #a0aec0;
            text-align: center;
            margin-top: 1rem;
        }
        /* ローディングスピナー */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-message {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="text-3xl font-bold text-center text-white mb-4">カー運転ゲーム</h1>

        <canvas id="gameCanvas"></canvas>

        <div id="scoreDisplay" class="score-display">スコア: 0</div>

        <div id="messageBox" class="message-box">
            左右の矢印キーで車を操作します。スタートボタンを押して開始！
        </div>

        <div class="btn-group">
            <button id="startButton" class="btn btn-primary">ゲームスタート</button>
            <button id="analyzeScoreButton" class="btn btn-secondary" style="display: none;">✨ AIでスコアを分析</button>
            <div id="loader" class="loader"></div>
        </div>

        <p class="instructions">
            障害物にぶつからないように避け続けよう！<br>
            スコアは避けた障害物の数で増えます。
        </p>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const analyzeScoreButton = document.getElementById('analyzeScoreButton');
        const messageBox = document.getElementById('messageBox');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const loader = document.getElementById('loader');

        // ゲームの状態
        let gameRunning = false;
        let score = 0;
        let animationFrameId;

        // プレイヤーの車
        const playerCar = {
            width: 40,
            height: 70,
            x: 0, // 初期化時に設定
            y: 0, // 初期化時に設定
            speed: 5 // 横移動速度
        };

        // 障害物 (他の車)
        let obstacles = [];
        const obstacleWidth = 40;
        const obstacleHeight = 70;
        const obstacleMinSpeed = 2;
        const obstacleMaxSpeed = 7;
        let obstacleSpawnInterval = 1000; // 障害物生成間隔 (ms)
        let lastObstacleSpawnTime = 0;

        // キー入力の状態
        const keys = {
            left: false,
            right: false
        };

        // ゲームの初期化
        function initializeGame() {
            gameRunning = false;
            score = 0;
            obstacles = [];
            playerCar.x = canvas.width / 2 - playerCar.width / 2; // 中央にリセット
            playerCar.y = canvas.height - 100; // 下の方にリセット
            scoreDisplay.textContent = `スコア: ${score}`;
            messageBox.textContent = '左右の矢印キーで車を操作します。スタートボタンを押して開始！';
            startButton.textContent = 'ゲームスタート'; // ボタンのテキストをリセット
            startButton.style.display = 'block'; // スタートボタンを表示
            analyzeScoreButton.style.display = 'none'; // 分析ボタンを非表示
            loader.style.display = 'none'; // ローダーを非表示
            draw(); // 初期画面を描画
        }

        // 描画関数
        function draw() {
            // 背景 (道路)
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#38a169'; // 緑の草地
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 道路本体 (灰色)
            const roadWidth = canvas.width * 0.6; // 道路の幅はキャンバスの60%
            const roadX = (canvas.width - roadWidth) / 2;
            ctx.fillStyle = '#4a5568'; // 濃い灰色
            ctx.fillRect(roadX, 0, roadWidth, canvas.height);

            // 道路の白線 (中央線と左右の線)
            ctx.fillStyle = '#e2e8f0'; // 白
            const lineWidth = 5;
            const lineDash = 20; // 点線の長さ
            const lineGap = 20; // 点線の間隔

            // 中央線 (点線)
            ctx.beginPath();
            ctx.setLineDash([lineDash, lineGap]);
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.lineWidth = lineWidth;
            ctx.strokeStyle = '#e2e8f0';
            ctx.stroke();

            // 道路の左右の線 (実線)
            ctx.setLineDash([]); // 点線をリセット
            ctx.beginPath();
            ctx.moveTo(roadX, 0);
            ctx.lineTo(roadX, canvas.height);
            ctx.moveTo(roadX + roadWidth, 0);
            ctx.lineTo(roadX + roadWidth, canvas.height);
            ctx.lineWidth = lineWidth;
            ctx.strokeStyle = '#e2e8f0';
            ctx.stroke();

            // プレイヤーの車
            ctx.fillStyle = '#63b3ed'; // 青い車
            ctx.fillRect(playerCar.x, playerCar.y, playerCar.width, playerCar.height);

            // 障害物
            obstacles.forEach(obstacle => {
                ctx.fillStyle = obstacle.color; // 障害物の色
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            });
        }

        // 更新関数 (ゲームロジック)
        function update() {
            if (!gameRunning) return;

            // プレイヤーの車の移動
            if (keys.left) {
                playerCar.x -= playerCar.speed;
            }
            if (keys.right) {
                playerCar.x += playerCar.speed;
            }

            // プレイヤーの車が道路の端からはみ出さないように制限
            const roadWidth = canvas.width * 0.6;
            const roadX = (canvas.width - roadWidth) / 2;
            if (playerCar.x < roadX) {
                playerCar.x = roadX;
            }
            if (playerCar.x + playerCar.width > roadX + roadWidth) {
                playerCar.x = roadX + roadWidth - playerCar.width;
            }

            // 障害物の生成
            const currentTime = Date.now();
            if (currentTime - lastObstacleSpawnTime > obstacleSpawnInterval) {
                spawnObstacle();
                lastObstacleSpawnTime = currentTime;
                // スコアに応じて障害物生成間隔を短くする (難易度アップ)
                if (obstacleSpawnInterval > 400) {
                    obstacleSpawnInterval -= 10;
                }
            }

            // 障害物の移動と削除、衝突判定
            for (let i = 0; i < obstacles.length; i++) {
                const obstacle = obstacles[i];
                obstacle.y += obstacle.speed;

                // 衝突判定 (AABB: Axis-Aligned Bounding Box)
                if (playerCar.x < obstacle.x + obstacle.width &&
                    playerCar.x + playerCar.width > obstacle.x &&
                    playerCar.y < obstacle.y + obstacle.height &&
                    playerCar.y + playerCar.height > obstacle.y) {
                    // 衝突した場合
                    gameOver();
                    return; // ゲームオーバーになったら更新を停止
                }

                // 画面外に出た障害物を削除し、スコアを加算
                if (obstacle.y > canvas.height) {
                    obstacles.splice(i, 1);
                    i--; // 配列から要素を削除したのでインデックスを調整
                    score++;
                    scoreDisplay.textContent = `スコア: ${score}`;
                }
            }
        }

        // 障害物を生成する関数
        function spawnObstacle() {
            const roadWidth = canvas.width * 0.6;
            const roadX = (canvas.width - roadWidth) / 2;

            const x = roadX + Math.random() * (roadWidth - obstacleWidth); // 道路内でランダムなX座標
            const speed = obstacleMinSpeed + Math.random() * (obstacleMaxSpeed - obstacleMinSpeed);
            const colors = ['#e53e3e', '#ecc94b', '#48bb78', '#9f7aea']; // 赤、黄、緑、紫
            const color = colors[Math.floor(Math.random() * colors.length)];

            obstacles.push({
                x: x,
                y: -obstacleHeight, // 画面上部から出現
                width: obstacleWidth,
                height: obstacleHeight,
                speed: speed,
                color: color
            });
        }

        // ゲームオーバー処理
        function gameOver() {
            gameRunning = false;
            cancelAnimationFrame(animationFrameId); // アニメーションループを停止
            messageBox.textContent = `ゲームオーバー！あなたのスコアは ${score} です。もう一度プレイしますか？`;
            startButton.textContent = 'もう一度プレイ';
            startButton.style.display = 'block'; // スタートボタンを再表示
            analyzeScoreButton.style.display = 'block'; // 分析ボタンを表示
        }

        // ゲームループ
        function gameLoop() {
            update();
            draw();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // --- Gemini API 統合 ---
        async function analyzeScoreWithAI(finalScore) {
            messageBox.innerHTML = '<div class="loading-message">AIがスコアを分析中...<div class="loader"></div></div>';
            analyzeScoreButton.disabled = true; // 分析ボタンを無効化
            startButton.disabled = true; // スタートボタンも無効化

            const prompt = `あなたは熟練したゲームアナリストです。以下のカー運転ゲームのスコアについて、短く、励ましや挑戦を促すようなコメントを日本語で生成してください。
            スコア: ${finalScore}
            
            コメント:`;

            const chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };

            const apiKey = ""; // Canvas環境で自動的に提供されます
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    messageBox.textContent = text;
                } else {
                    messageBox.textContent = 'AIによる分析に失敗しました。';
                    console.error('Gemini API response structure unexpected:', result);
                }
            } catch (error) {
                messageBox.textContent = 'AIとの通信中にエラーが発生しました。';
                console.error('Error calling Gemini API:', error);
            } finally {
                analyzeScoreButton.disabled = false; // 分析ボタンを再度有効化
                startButton.disabled = false; // スタートボタンも再度有効化
                loader.style.display = 'none'; // ローダーを非表示
            }
        }

        // イベントリスナー
        startButton.addEventListener('click', () => {
            initializeGame(); // ゲームをリセット
            gameRunning = true;
            startButton.style.display = 'none'; // スタートボタンを非表示
            analyzeScoreButton.style.display = 'none'; // 分析ボタンも非表示
            messageBox.textContent = 'ゲーム中！障害物を避けよう！';
            lastObstacleSpawnTime = Date.now(); // 障害物生成タイマーをリセット
            obstacleSpawnInterval = 1000; // 障害物生成間隔を初期値に戻す
            gameLoop(); // ゲームループを開始
        });

        analyzeScoreButton.addEventListener('click', () => {
            analyzeScoreWithAI(score); // 現在のスコアをAIに渡して分析
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                keys.left = true;
            } else if (e.key === 'ArrowRight') {
                keys.right = true;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft') {
                keys.left = false;
            } else if (e.key === 'ArrowRight') {
                keys.right = false;
            }
        });

        // ウィンドウのリサイズ時にキャンバスサイズを調整
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth > 400 ? 400 : container.clientWidth; // 最大幅400px
            canvas.height = 500; // 高さは固定
            playerCar.x = canvas.width / 2 - playerCar.width / 2; // 車の位置を中央に調整
            playerCar.y = canvas.height - 100; // 車の位置を下の方に調整
            draw(); // 再描画
        }

        window.addEventListener('resize', resizeCanvas);
        window.onload = () => {
            resizeCanvas(); // 初期ロード時にもリサイズ
            initializeGame(); // ゲームを初期化
        };
    </script>
</body>
</html>
