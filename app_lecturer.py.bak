#!/usr/bin/env python3
# -----------------------------------------------------------------------------
# DESCRIPTION: スクリプト内のアプリの説明ランク５）
# Version: 
# Category: 0
# -----------------------------------------------------------------------------
import os
import sys
import re

# プロジェクトルートを設定し、ユーティリティモジュールをインポートできるようにする
_current_dir = os.path.dirname(os.path.abspath(__file__))
_project_name = "my_gemini_project" 

PROJECT_ROOT = _current_dir
while not os.path.basename(PROJECT_ROOT) == _project_name and PROJECT_ROOT != '/':
    PROJECT_ROOT = os.path.dirname(PROJECT_ROOT)

if os.path.basename(PROJECT_ROOT) != _project_name:
    print(f"Error: Could not find project root directory '{_project_name}'. Current path: {os.getcwd()}", file=sys.stderr)
    sys.exit(1)

# utilsディレクトリとsub_programsディレクトリをPythonの検索パスに追加
utils_path = os.path.join(PROJECT_ROOT, 'utils')
if os.path.isdir(utils_path) and utils_path not in sys.path:
    sys.path.append(utils_path)

sub_programs_path = os.path.join(PROJECT_ROOT, 'sub_programs')
if os.path.isdir(sub_programs_path) and sub_programs_path not in sys.path:
    sys.path.append(sub_programs_path)

# 必要なユーティリティをインポート
try:
    from display_utils import print_header, select_from_list, press_enter_to_continue, print_result, print_error, get_user_input
    from file_utils import get_script_files_in_dir, load_file_content
    # 修正: call_gemini_api を query_gemini に変更
    from gemini_utils import initialize_gemini_model, query_gemini
except ImportError as e:
    print(f"Error: Required modules not found. Check 'utils'/'sub_programs' paths. {e}", file=sys.stderr)
    sys.exit(1)

# APIキーを環境変数から取得 (Gemini API利用のため)
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
if not GEMINI_API_KEY:
    api_file_path = os.path.join(PROJECT_ROOT, 'api')
    if os.path.exists(api_file_path):
        try:
            with open(api_file_path, 'r') as f:
                GEMINI_API_KEY = f.read().strip()
            os.environ["GEMINI_API_KEY"] = GEMINI_API_KEY # 環境変数に設定
            print_result("APIキーをファイルから読み込みました。", "apiファイル")
        except Exception as e:
            print_error(f"APIキーファイル '{api_file_path}' の読み込み中にエラーが発生しました: {e}")
            sys.exit(1)
    else:
        print_error("GEMINI_API_KEY 環境変数が設定されていません。")
        print_error(f"また、APIキーファイル '{api_file_path}' も見つかりません。")
        print_error("Gemini API関連の機能は動作しません。")
        sys.exit(1)

# APIキーが設定されたことを確認
if not GEMINI_API_KEY:
    print_error("APIキーが設定されていません。Gemini API関連の機能は動作しません。")
    sys.exit(1)

# Geminiモデルを初期化
gemini_model = initialize_gemini_model(model_name='gemini-1.5-flash')


def get_app_details(app_path: str) -> dict:
    """
    スクリプトファイルからアプリ名と説明を抽出し、辞書として返す。
    """
    filename = os.path.basename(app_path)
    description = ""
    
    content = load_file_content(app_path)
    if content:
        # # DESCRIPTION: から説明を抽出
        desc_match = re.search(r"^# DESCRIPTION:\s*(.*)", content, re.MULTILINE)
        if desc_match:
            description = desc_match.group(1).strip()
        else:
            # 説明がない場合はファイル名から推測
            if filename.endswith(".py"):
                description = f"{filename.replace('.py', '').replace('_', ' ').title()} アプリ"
            elif filename.endswith(".sh"):
                description = f"{filename.replace('.sh', '').replace('_', ' ').title()} スクリプト"
            else:
                description = f"{filename} (説明なし)"
    else:
        description = f"{filename} (読み込みエラー)"
        
    return {'name': filename, 'path': app_path, 'description': description}

def analyze_app_with_gemini(app_details: dict) -> str:
    """
    Geminiにアプリのコードを分析させ、詳細なレクチャーを生成させる。
    """
    app_code = load_file_content(app_details['path'])
    if not app_code:
        return "エラー: アプリのコードを読み込めませんでした。"

    prompt = f"""
    以下のYggdrasil PrototypeのPython/シェルスクリプトアプリケーションのコードを詳細に分析し、その利用方法、主な機能、内部ロジックの概要、および将来的な改善点について、ユーザー向けに分かりやすく解説してください。

    --- アプリケーション情報 ---
    ファイル名: {app_details['name']}
    説明: {app_details['description']}

    --- コード ---
    ```
    {app_code}
    ```

    --- レクチャー内容 ---
    1.  **アプリの概要と目的:**
    2.  **主な機能と利用方法:**
    3.  **内部ロジックの簡単な解説:** (重要な関数やクラスについて)
    4.  **将来的な改善点や拡張の可能性:**
    5.  **注意点:** (Gemini APIキーの必要性、依存ライブラリなど)
    """
    
    print(f"\nGeminiがアプリ '{app_details['name']}' のレクチャーを生成中です。しばらくお待ちください...")
    # 修正: call_gemini_api を query_gemini に変更
    response_text = query_gemini(gemini_model, prompt)
    return response_text


def main():
    print_header("アプリ利用レクチャー")

    scripts_dir = os.path.join(PROJECT_ROOT, 'scripts')
    
    # 実行可能なスクリプトのファイルパスを取得
    script_paths = get_script_files_in_dir(scripts_dir)
    
    if not script_paths:
        print_error("scripts/ ディレクトリに実行可能なスクリプトが見つかりません。")
        press_enter_to_continue()
        return

    # 各スクリプトの詳細情報を取得し、表示用のリストを作成
    display_options = []
    all_scripts_details = [] # アプリの詳細情報を格納するリスト
    for path in script_paths:
        app_details = get_app_details(path)
        all_scripts_details.append(app_details)
        display_options.append(f"[{app_details['name']}] - {app_details['description']}")
    
    # display_utils.select_from_list を使用してユーザーに選択させる
    selected_index = select_from_list(display_options, "レクチャーを受けたいアプリを選択してください: ")

    if selected_index is not None: # None は 'q' または 'b' が選択された場合
        if isinstance(selected_index, int): # 単一選択の場合
            # インデックスは1から始まるので、0ベースに変換
            selected_app_details = all_scripts_details[selected_index - 1]
            
            # Geminiにアプリのレクチャーを依頼
            lecture_content = analyze_app_with_gemini(selected_app_details)
            print_result(f"'{selected_app_details['name']}' のレクチャー", lecture_content)
        else: # 複数選択の場合 (今回は単一選択なので、このパスは通常通らない)
            print_error("複数選択は現在サポートされていません。")
    else:
        print("アプリの選択がキャンセルされました。")

    press_enter_to_continue()

if __name__ == "__main__":
    main()
